#jinja2: trim_blocks: True,lstrip_blocks: True
{################################
PURPOSE: Configure xSTP 

################################
Example:
dellos_xstp:
  OS6:
    type: mstp
    pvst_vlans: 2,11
    bridge_priority: 4096
    mstp_instances:
      - number: 1
        vlans: 10,12
        bridge_priority: 4096
        vlans_state: present
    state: present

################################}

{% set xstp_vars = dellos_xstp[hostname] %}
{% if xstp_vars.type is defined and xstp_vars.type %}
  {% if xstp_vars.state is defined and xstp_vars.state=="absent" %}
no spanning-tree 
  {% else %}
spanning-tree mode {{ xstp_vars.type }}
    {% if xstp_vars.type == "rstp" %}
      {% if xstp_vars.bridge_priority is defined and xstp_vars.bridge_priority %}
spanning-tree priority {{ xstp_vars.bridge_priority }}
      {% else %}
no spanning-tree priority
      {% endif %}
    {% endif %}
    {% if xstp_vars.type == "rapid-pvst" or xstp_vars.type == "pvst" %}
    {% set values = xstp_vars.pvst_vlans.split(",") %}
      {% for val in values %}
        {% if xstp_vars.pvst_vlans is defined and xstp_vars.pvst_vlans %}
          {% if xstp_vars.bridge_priority is defined %}
            {% if xstp_vars.bridge_priority %}
spanning-tree vlan {{ val }} priority {{ xstp_vars.bridge_priority }}
            {% else %}
no spanning-tree vlan {{ val }} priority
            {% endif %}
          {% else %}
spanning-tree vlan {{ val }}
          {% endif %}
        {% else %}
no spanning-tree vlan {{ val }}
        {% endif %}
      {% endfor %}
    {% endif %}
    {% if xstp_vars.type == "mst" %}
      {% if xstp_vars.mstp_instances is defined and xstp_vars.mstp_instances %}
        {% for instance in xstp_vars.mstp_instances %}
          {% if (instance.number is defined and instance.number) %}
            {% if instance.bridge_priority is defined and instance.bridge_priority %}
spanning-tree mst {{ instance.number }} priority {{ instance.bridge_priority }}
            {% else %}
no spanning-tree mst {{ instance.number }} priority
            {% endif %}
            {% set values = instance.vlans.split(",") %}
            {% for val in values %}
              {% if instance.vlans is defined and instance.vlans %}
spanning-tree {{ xstp_vars.type }} configuration
                {% if instance.vlans_state is defined and instance.vlans_state=="absent" %}
instance {{ instance.number }} remove vlan {{ val }}
                {% else %}
instance {{ instance.number }} add vlan {{ val }}
                {% endif %}
exit
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endfor %}
      {% endif %}
   {% endif %}
 {% endif %}
{% endif %}
