#jinja2: trim_blocks: True, lstrip_blocks: True
{#############################################
PURPOSE: Configure xSTP on OS9 Devices

##############################################
Example:
dellos_xstp:
  OS9:
    type: mstp
    pvst_vlans: 2,11
    bridge_priority: 4096
    mstp_instances:
      - number: 1
        vlans: 10,12
        bridge_priority: 4096
        vlans_state: present
    state: present

############################################}

{% set xstp_vars = dellos_xstp[hostname] %}
{% if xstp_vars.type is defined and xstp_vars.type %}
  {% if xstp_vars.state is defined and xstp_vars.state == "absent" %}
    {% if xstp_vars.type == "stp" %}
no protocol spanning-tree 0
    {% else %}
no protocol spanning-tree {{ xstp_vars.type }}
    {% endif %}
  {% else %}
    {% if xstp_vars.type == "stp" %}
protocol spanning-tree 0
 no disable
      {% if xstp_vars.bridge_priority is defined and xstp_vars.bridge_priority %}
 bridge-priority {{ xstp_vars.bridge_priority }}
      {% else %}
 no bridge-priority
      {% endif %} 
    {% endif %}

    {% if xstp_vars.type == "rstp" %}
protocol spanning-tree {{ xstp_vars.type }}
 no disable
      {% if xstp_vars.bridge_priority is defined and xstp_vars.bridge_priority %}
 bridge-priority {{ xstp_vars.bridge_priority }}
      {% else %}
 no bridge-priority
      {% endif %}
    {% endif %}
  
    {% if xstp_vars.type == "pvst" %}
protocol spanning-tree {{ xstp_vars.type }}
 no disable
      {% if xstp_vars.pvst_vlans is defined and xstp_vars.pvst_vlans %}
        {% if xstp_vars.bridge_priority is defined and xstp_vars.bridge_priority %}
 vlan {{ xstp_vars.pvst_vlans }} bridge-priority {{ xstp_vars.bridge_priority }}
        {% else %}
 no vlan {{ xstp_vars.pvst_vlans }} bridge-priority
        {% endif %}
      {% endif %}
    {% endif %}

    {% if xstp_vars.type == "mstp" %}
protocol spanning-tree mstp
 no disable
      {% if xstp_vars.mstp_instances is defined and xstp_vars.mstp_instances %}
        {% for instance in xstp_vars.mstp_instances %}
          {% if (instance.number is defined and instance.number) %}
            {% if instance.bridge_priority is defined and instance.bridge_priority %}
 MSTI {{ instance.number }} bridge-priority {{ instance.bridge_priority }}
            {% else %}
 no MSTI {{ instance.number }} bridge-priority
             {% endif %}

             {% if instance.vlans is defined and instance.vlans %}
               {% if instance.vlans_state is defined and instance.vlans_state == "absent" %}
 no MSTI {{ instance.number }} VLAN {{ instance.vlans }}
               {% else %}
 MSTI {{ instance.number }} VLAN {{ instance.vlans }}
               {% endif %}
             {% endif %}
           {% endif %}
         {% endfor %}
       {% endif %}
    {% endif %}

  {% endif %}
{% endif %}
